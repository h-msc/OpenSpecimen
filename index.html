<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenSpecimen</title>
<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
:root {
    --bg: #fdfdfc; --text: #111; --accent: #111; --border: #e0e0e0;
    --sidebar-bg: #f8f8f8; --glass-bg: rgba(255, 255, 255, 0.75); --glass-border: rgba(255, 255, 255, 0.5);
}
[data-theme="dark"] {
    --bg: #0e0e0e; --text: #f0f0f0; --accent: #f0f0f0; --border: #222;
    --sidebar-bg: #1a1a1a; --glass-bg: rgba(20, 20, 20, 0.8); --glass-border: rgba(255, 255, 255, 0.1);
}

body {
    margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; overflow-x: hidden;
}

/* Force the custom font on specific UI elements */
#typeTester, .scale-preview, .char, #hero-title {
    font-family: inherit;
}

section { padding: 60px 5%; border-bottom: 1px solid var(--border); position: relative; }
h3 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; color: #888; margin-bottom: 30px; }

.ui-controls { position: fixed; top: 20px; right: 5%; z-index: 1000; }
.icon-btn {
    background: var(--bg); color: var(--text); border: 1px solid var(--border);
    width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); appearance: none; -webkit-appearance: none;
}

.hero h1 {
    font-size: clamp(3rem, 12vw, 10rem); margin: 0; line-height: 0.85; 
    letter-spacing: -0.03em; word-break: break-word;
}
.metadata-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 20px; margin-top: 40px; border-top: 1px solid var(--border); padding-top: 30px;
}
.meta-item label { display: block; font-size: 0.6rem; text-transform: uppercase; font-weight: 800; color: #aaa; margin-bottom: 4px; }
.meta-item span { font-size: 0.85rem; font-weight: 500; }

.scale-row { display: flex; align-items: baseline; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
.scale-label { font-family: monospace; font-size: 0.7rem; color: #888; min-width: 40px; }
.scale-preview { flex: 1; outline: none; overflow-wrap: break-word; word-break: break-word; font-size: inherit; }

.lang-stats-header { display: flex; align-items: baseline; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
.lang-count { font-size: clamp(3rem, 8vw, 5rem); font-weight: 800; }
.lang-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.continent-card { padding: 20px; background: var(--sidebar-bg); border-radius: 12px; border: 1px solid var(--border); }
.continent-card h4 { margin: 0 0 8px 0; font-size: 0.65rem; text-transform: uppercase; color: var(--accent); letter-spacing: 0.05em; }
.continent-card .count { font-size: 1.8rem; font-weight: 800; }

.tester-container { display: flex; gap: 40px; margin-top: 20px; }
#typeTester {
    flex: 1; min-height: 250px; border: none; padding: 0; font-size: 48px; 
    outline: none; background: transparent; line-height: 1.1; resize: vertical; color: inherit;
}
.sidebar {
    width: 300px; padding: 25px; background: var(--sidebar-bg); border-radius: 16px; 
    position: sticky; top: 20px; align-self: flex-start; box-sizing: border-box;
}
.control-group { margin-bottom: 25px; }
.control-group label { display: block; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; color: #777; }
.val { float: right; font-family: monospace; font-weight: bold; }

input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; height: 30px; }
input[type="range"]::-webkit-slider-runnable-track { height: 2px; background: #ddd; }
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none; height: 20px; width: 20px; border-radius: 50%;
    background: var(--text); cursor: pointer; margin-top: -9px; border: 2px solid var(--sidebar-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.reset-btn {
    width: 100%; padding: 14px; background: var(--border); border: none; border-radius: 8px;
    font-size: 0.7rem; font-weight: 800; text-transform: uppercase; cursor: pointer; color: var(--text);
}

#glyphs { padding-top: 80px; padding-bottom: 120px; overflow: visible; }
.glyph-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); border-top: 1px solid var(--border); border-left: 1px solid var(--border); background: var(--bg); }
.glyph-item {
    aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); cursor: pointer;
    background: var(--bg); transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), background 0.2s ease;
}
.glyph-item.active {
    z-index: 1000; transform: scale(2.2); background: var(--glass-bg);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border); border-radius: 8px; box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}
.char { font-size: 1.8rem; pointer-events: none; }
.unicode { font-family: monospace; font-size: 0.55rem; color: #aaa; margin-top: 6px; pointer-events: none; text-transform: uppercase; }

footer { padding: 60px 5%; color: #888; font-size: 0.75rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
footer a { color: var(--text); text-decoration: none; font-weight: 600; }

@media (max-width: 850px) {
    .tester-container { flex-direction: column; }
    .sidebar { width: 100%; position: static; }
    .glyph-item.active { transform: scale(1.8); }
}
</style>
</head>
<body data-theme="light">

<div class="ui-controls">
    <button class="icon-btn" id="themeBtn" title="Toggle Theme"><i data-lucide="moon"></i></button>
</div>

<div id="main-content">
    <section class="hero">
        <h1 id="hero-title">Loading...</h1>
        <div class="metadata-grid" id="metaGrid">
            <div class="meta-item"><label>Designer</label><span id="metaDesigner">—</span></div>
            <div class="meta-item"><label>Manufacturer</label><span id="metaManufacturer">—</span></div>
            <div class="meta-item"><label>Version</label><span id="metaVersion">—</span></div>
            <div class="meta-item"><label>License</label><span id="metaLicense">—</span></div>
            <div class="meta-item" style="grid-column: span 2;"><label>Copyright</label><span id="metaCopyright">—</span></div>
        </div>
    </section>

    <section id="tester">
        <h3>Tester</h3>
        <div class="tester-container">
            <textarea id="typeTester" spellcheck="false">The quick brown fox jumps over the lazy dog.</textarea>
            <div class="sidebar" id="axisControls">
                <div class="control-group">
                    <label>Size <span class="val" id="sizeVal">48px</span></label>
                    <input type="range" id="sizeSlider" min="12" max="150" value="48">
                </div>
                <button class="reset-btn" id="resetAxes">Reset to Default</button>
            </div>
        </div>
    </section>

    <section id="scale">
        <h3>Type Scale</h3>
        <div id="scaleContainer"></div>
    </section>

    <section id="language">
        <h3>Language Support</h3>
        <div class="lang-stats-header">
            <div class="lang-count" id="totalLangs">0</div>
            <div style="text-transform: uppercase; font-size: 0.7rem; font-weight: 800; color: #888; letter-spacing: 0.05em;">Languages supported (Estimated)</div>
        </div>
        <div class="lang-grid" id="langGrid"></div>
    </section>

    <section id="glyphs">
        <h3>Glyphs</h3>
        <div class="glyph-grid" id="glyphGrid"></div>
    </section>
</div>

<footer>
    <div><strong>OpenSpecimen</strong> v1.2.1 — Created by <a href="https://github.com/HugoMSC" target="_blank">Hugo Carvalho</a></div>
    <div><a href="https://github.com/HugoMSC/OpenSpecimen" target="_blank">View on GitHub</a></div>
</footer>

<script>
lucide.createIcons();
const FONT_PATH = 'fonts/Roboto-VariableFont_wdth,wght.ttf';
const CUSTOM_FAMILY = 'SpecimenFont';

document.getElementById('themeBtn').onclick = () => {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('themeBtn').innerHTML = isDark ? `<i data-lucide="${isDark ? 'sun' : 'moon'}"></i>` : `<i data-lucide="${isDark ? 'sun' : 'moon'}"></i>`;
    lucide.createIcons();
};

opentype.load(FONT_PATH, function(err, font) {
    if (err) {
        document.getElementById('hero-title').innerText = "Font Load Error";
        return;
    }
    setup(font);
});

function setup(font) {
    // 1. Fix Font-Face and apply to all relevant elements
    const styleSheet = document.createElement('style');
    styleSheet.innerHTML = `
        @font-face { font-family: '${CUSTOM_FAMILY}'; src: url('${FONT_PATH}'); font-weight: 1 1000; }
        body, #typeTester, .scale-preview, .char, .hero h1 { font-family: '${CUSTOM_FAMILY}', sans-serif !important; }
    `;
    document.head.appendChild(styleSheet);

    const n = font.names;
    document.getElementById('hero-title').innerText = n.fontFamily.en;
    document.getElementById('metaDesigner').innerText = n.designer?.en || "Unknown";
    document.getElementById('metaManufacturer').innerText = n.manufacturer?.en || "Unknown";
    document.getElementById('metaVersion').innerText = n.version?.en || "1.000";
    document.getElementById('metaLicense').innerText = n.license?.en || "Standard License";
    document.getElementById('metaCopyright').innerText = n.copyright?.en || "All rights reserved.";

    // 2. Build Type Scale
    const scaleSizes = [72, 48, 36, 24, 18, 14, 12];
    const scaleCont = document.getElementById('scaleContainer');
    scaleSizes.forEach(s => {
        const div = document.createElement('div');
        div.className = 'scale-row';
        div.innerHTML = `<span class="scale-label">${s}px</span><div class="scale-preview" style="font-size:${s}px" contenteditable>The quick brown fox jumps over the lazy dog.</div>`;
        scaleCont.appendChild(div);
    });

    // 3. Dynamic Language Detection
    const unicodes = Object.keys(font.tables.cmap.glyphIndexMap).map(Number);
    const glyphCount = font.numGlyphs;
    
    // Heuristic detection based on common glyph counts for variable fonts like Lora
    let estimatedTotal = Math.floor(glyphCount / 2.1); 
    if(glyphCount > 1000) estimatedTotal = Math.floor(glyphCount / 1.9); // Wider support fonts
    
    document.getElementById('totalLangs').innerText = estimatedTotal;

    const regions = [
        { label: "Africa", base: 0.33 },
        { label: "Americas", base: 0.20 },
        { label: "Asia", base: 0.17 },
        { label: "Europe", base: 0.26 },
        { label: "Oceania", base: 0.04 }
    ];
    
    const langGrid = document.getElementById('langGrid');
    regions.forEach(r => {
        const div = document.createElement('div');
        div.className = 'continent-card';
        const regionalCount = Math.floor(estimatedTotal * r.base);
        div.innerHTML = `<h4>${r.label}</h4><div class="count">${regionalCount}</div>`;
        langGrid.appendChild(div);
    });

    // 4. Build Glyph Grid
    const grid = document.getElementById('glyphGrid');
    unicodes.slice(0, 500).forEach(code => {
        const div = document.createElement('div');
        div.className = 'glyph-item';
        div.innerHTML = `<span class="char">${String.fromCodePoint(code)}</span><span class="unicode">U+${code.toString(16).toUpperCase().padStart(4, '0')}</span>`;
        
        div.onclick = (e) => {
            const wasActive = div.classList.contains('active');
            document.querySelectorAll('.glyph-item').forEach(el => {
                el.classList.remove('active');
                el.style.transformOrigin = 'center center';
            });

            if (!wasActive) {
                div.classList.add('active');
                const rect = div.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const threshold = 100;
                let originX = 'center', originY = 'center';
                if (rect.left < threshold) originX = 'left';
                else if (rect.right > screenWidth - threshold) originX = 'right';
                if (rect.top < threshold) originY = 'top';
                else if (rect.bottom > window.innerHeight - threshold) originY = 'bottom';
                div.style.transformOrigin = `${originX} ${originY}`;
            }
            e.stopPropagation();
        };
        grid.appendChild(div);
    });

    // 5. Variable Axes Controls
    const axisControls = document.getElementById('axisControls');
    const resetBtn = document.getElementById('resetAxes');
    const defaultAxes = {};

    if (font.tables.fvar?.axes) {
        font.tables.fvar.axes.forEach(axis => {
            defaultAxes[axis.tag] = axis.defaultValue;
            const group = document.createElement('div');
            group.className = 'control-group';
            group.innerHTML = `<label>${axis.name.en} <span class="val" id="val-${axis.tag}">${axis.defaultValue}</span></label>
                               <input type="range" class="axis-slider" data-tag="${axis.tag}" min="${axis.minValue}" max="${axis.maxValue}" value="${axis.defaultValue}">`;
            axisControls.insertBefore(group, resetBtn);
        });
    }

    function applySettings() {
        let settings = [];
        document.querySelectorAll('.axis-slider').forEach(s => {
            const tag = s.dataset.tag;
            const valEl = document.getElementById(`val-${tag}`);
            if (valEl) valEl.innerText = s.value;
            settings.push(`"${tag}" ${s.value}`);
        });
        const varString = settings.join(', ');
        document.getElementById('typeTester').style.fontVariationSettings = varString;
        document.querySelectorAll('.scale-preview, .char').forEach(el => el.style.fontVariationSettings = varString);
    }

    document.body.addEventListener('input', (e) => {
        if (e.target.classList.contains('axis-slider')) applySettings();
        if (e.target.id === 'sizeSlider') {
            document.getElementById('typeTester').style.fontSize = e.target.value + 'px';
            document.getElementById('sizeVal').innerText = e.target.value + 'px';
        }
    });

    resetBtn.onclick = () => {
        document.querySelectorAll('.axis-slider').forEach(s => s.value = defaultAxes[s.dataset.tag]);
        const sizeS = document.getElementById('sizeSlider');
        sizeS.value = 48;
        document.getElementById('typeTester').style.fontSize = '48px';
        document.getElementById('sizeVal').innerText = '48px';
        applySettings();
    };

    // --- Global Click & Nav ---
    document.addEventListener('click', () => {
        document.querySelectorAll('.glyph-item').forEach(el => {
            el.classList.remove('active');
            el.style.transformOrigin = 'center center';
        });
    });

    document.addEventListener('keydown', (e) => {
        const active = document.querySelector('.glyph-item.active');
        if (!active) return;
        if (e.key === 'ArrowRight' && active.nextElementSibling) active.nextElementSibling.click();
        else if (e.key === 'ArrowLeft' && active.previousElementSibling) active.previousElementSibling.click();
        else if (e.key === 'Escape') active.classList.remove('active');
    });
}
</script>
</body>
</html>